# Plan: Refine Onboarding — Personal Profile Collection

## Context

Currently the onboarding wizard is 5 steps:
1. Welcome → 2. Accounts → 3. VIP Contacts → 4. About You (Mad Libs) → 5. Sync Config

Step 4 ("About You") is a single Mad Libs card that collects: **role, company, 2 priorities, work days/hours, VIP emails**. That's it.

The user wants to expand this into a richer "personal profile" that captures the user's full life context — the kind of information needed for IdeaBox to truly organize their email intelligently across all 13 life-bucket categories.

## What We're Adding

The new profile data breaks into these logical sections:

### Section A: Identity (pre-populated from Google account)
- **Full name** (from Google profile — confirm/edit)
- **Gender** (new — optional, select)
- **Birthday** (new — date picker)
- **Profile photo** (already have from Google `avatarUrl`)

### Section B: Household
- **Who lives in your house** — a dynamic list of people with:
  - Name
  - Relationship (spouse/partner, child, parent, sibling, roommate, other)
  - Gender (optional)
  - Birthday (optional)
  - School name (for kids — optional, shown conditionally)
- **Pets** — name + type (dog, cat, etc.)

### Section C: Location & Cities
- **Home address** (street, city, state, zip — for local event matching)
- **Other cities you care about** — array of city strings with tags like "hometown", "travel frequently", "family lives there", "vacation spot"

### Section D: Work & Income (evolve existing Mad Libs)
- **Primary job** — role + company/self-employed + industry (already partially exists)
- **Employment type** — employed, self-employed, both
- **Other jobs/hustles** — array of { role, company/description, is_self_employed }
- **Clients** — initially populated by scanning email contacts, user confirms. Each client: { name, email_domain, contact_emails[] }

### Section E: Work Schedule (already exists)
- Work days, start/end times (keep as-is)

### Section F: Priorities & Interests (already exists)
- Priorities (keep)
- Interests (not yet in onboarding, but in settings)

## Implementation Approach

### Onboarding UX: Multi-section profile step with tabs/accordion

Rather than one overwhelming mega-form, we'll replace the single "About You" step with a **multi-section profile step** that uses a tabbed or vertical stepper within the card. Each section is a distinct, focused mini-form. The user can complete sections in any order and skip any section.

**New step 4 will be called "Your Profile"** and contain sub-sections:
1. **You** — name, gender, birthday (pre-filled from Google)
2. **Household** — family members, pets
3. **Where You Live** — address, other cities
4. **Work** — primary job, other hustles, clients
5. **Schedule & Priorities** — work hours, priorities (moved from current Mad Libs)

The VIP Contacts step (3) stays as-is. Sync Config step (5) stays as-is.

### Database Changes (migration-040)

**Expand `user_context` table** with new columns:
```sql
-- Identity
gender TEXT,                                    -- optional: male, female, non-binary, prefer-not-to-say
birthday DATE,                                  -- user's birthday

-- Address
address_street TEXT,
address_city TEXT,
address_state TEXT,
address_zip TEXT,
address_country TEXT DEFAULT 'US',

-- Other cities (JSONB array)
-- Each: { city: "Chicago, IL", tag: "hometown" | "travel" | "family" | "other", note?: string }
other_cities JSONB DEFAULT '[]'::jsonb,

-- Employment
employment_type TEXT DEFAULT 'employed',         -- employed, self_employed, both
other_jobs JSONB DEFAULT '[]'::jsonb,            -- Array of { role, company, is_self_employed }

-- Household (replace basic family_context with richer structure)
household_members JSONB DEFAULT '[]'::jsonb,     -- Array of { name, relationship, gender?, birthday?, school? }
pets JSONB DEFAULT '[]'::jsonb,                  -- Array of { name, type }
```

Note: `family_context` JSONB already exists but is too simple (just spouse_name, kids_count, family_names). We'll migrate to the richer `household_members` structure.

### Files to Create/Modify

**New Files:**
1. `scripts/migration-040-profile-expansion.sql` — DB migration
2. `src/app/onboarding/components/ProfileStep.tsx` — New orchestrator component (replaces MadLibsProfileStep)
3. `src/app/onboarding/components/profile/IdentitySection.tsx` — You section
4. `src/app/onboarding/components/profile/HouseholdSection.tsx` — Household section
5. `src/app/onboarding/components/profile/LocationSection.tsx` — Where You Live section
6. `src/app/onboarding/components/profile/WorkSection.tsx` — Work section
7. `src/app/onboarding/components/profile/ScheduleSection.tsx` — Schedule & Priorities (refactored from MadLibs)
8. `src/app/onboarding/components/profile/ClientSuggestions.tsx` — Client picker from email contacts

**Modified Files:**
1. `src/types/database.ts` — Add new types for household, other_cities, other_jobs, pets, etc.
2. `src/lib/api/schemas.ts` — Add Zod schemas for new profile fields
3. `src/services/user-context/user-context-service.ts` — Update `UserContextRow`, `UserContextUpdate`, transform functions
4. `src/hooks/useUserContext.ts` — Add new fields to `UserContext` interface, update completion tracking
5. `src/app/onboarding/components/OnboardingWizard.tsx` — Replace MadLibsProfileStep lazy import with ProfileStep
6. `src/app/api/user/context/route.ts` — Already supports partial updates (no changes needed)
7. `src/app/(auth)/settings/page.tsx` — Update "About Me" tab to show new fields (later PR, not in this scope)

### Implementation Order

1. **Migration & types** — DB migration SQL, TypeScript types, Zod schemas
2. **Service layer** — Update user-context-service with new fields
3. **ProfileStep orchestrator** — Tabbed container that replaces MadLibsProfileStep
4. **Section components** — Build each sub-section (Identity → Household → Location → Work → Schedule)
5. **Client suggestions** — API endpoint that pulls likely clients from contacts
6. **Wire into wizard** — Swap MadLibsProfileStep for ProfileStep in OnboardingWizard
7. **Update useUserContext hook** — New fields in completion tracking

### What We're NOT Doing (out of scope)
- Updating the Settings "About Me" tab (follow-up PR)
- LinkedIn/website scraping for auto-populate (future enhancement — noted in code comments)
- Google Calendar integration for birthday/event extraction
- Modifying any AI analyzers to use the new data (separate task)
