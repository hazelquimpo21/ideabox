# Plan: Surface Email Analyzer Data Across All UI (2 Phases)

## Context

IdeaBox has 14 AI analyzers producing rich intelligence from every email. An audit revealed that while **EmailDetail** is comprehensive, the rest of the app has meaningful gaps. List views, modals, the sidebar, contacts, and calendar under-utilize the data we're already extracting and paying for.

**Goal:** Every surface a user touches should reflect the intelligence we've already computed â€” without overwhelming them. Show the *right* data at the *right* density for each context.

### Design Principles
1. **Progressive disclosure** â€” List views show signals (dots, badges, icons). Detail views show substance. Hover/click reveals depth.
2. **No dead code** â€” If a field is referenced in a component, it must actually exist on the queried data. Fix or remove.
3. **Consistency** â€” The same field should look the same everywhere (same colors, same icons, same position).
4. **Earned complexity** â€” Only add UI elements that help the user make a faster decision.

---

## Phase 1: Fix Gaps, Kill Dead Code, Strengthen Core Views

**Theme:** Make what we have *work correctly* everywhere. No new analyzer features â€” just fully surface what's already computed.

### 1.1 â€” Denormalize Missing Fields (Migration)

**Problem:** `urgency_score` and `relationship_signal` are referenced in CategoryEmailCard but only exist in `email_analyses` JSONB â€” the component reads `email.urgency_score` and `email.relationship_signal` which are always `undefined`. This is dead code today.

**Fix:** New migration to add these as real columns on `emails` table + update the email processor to denormalize them alongside the existing fields.

**Files:**
- `supabase/migrations/043_denormalize_urgency_relationship.sql` â€” Add columns
- `src/services/processors/email-processor.ts` â€” Denormalize after analysis
- `src/types/database.ts` â€” Add fields to Email type
- `src/hooks/useEmails.ts` â€” Add to `EMAIL_LIST_FIELDS`

**Columns:**
```sql
ALTER TABLE emails ADD COLUMN urgency_score INTEGER;
ALTER TABLE emails ADD COLUMN relationship_signal TEXT; -- positive, neutral, negative, unknown
```

### 1.2 â€” CategoryModal Gets the Same Treatment as Inbox

**Problem:** CategoryModal renders email items using a simplified ModalEmailItem that only shows subject, sender, date, gist, and star. It's missing signal_strength, reply_worthiness, quick_action badges, additional_categories â€” everything we just added to InboxEmailRow/Card.

**Fix:** Upgrade ModalEmailItem to show the same at-a-glance indicators as InboxEmailRow. Since CategoryModal already queries the full `MODAL_LIST_FIELDS` set, the data is there â€” it's just not rendered.

**Files:**
- `src/components/discover/CategoryModal.tsx` â€” Enhance ModalEmailItem JSX

**Add to each row:**
- Signal strength dot
- Reply worthiness badge
- Quick action badge
- Additional category pills (if different from the modal's category)

### 1.3 â€” EmailPreviewModal: Add Analysis Summary

**Problem:** EmailPreviewModal (used from calendar/events to view the source email) shows raw email content but zero analysis. When a user taps "View source email" from a calendar event, they see the email body but not *why* IdeaBox extracted an event from it.

**Fix:** Add a compact analysis summary bar above the email body showing: category badge, signal strength, quick action, and a link to "View full analysis in Inbox."

**Files:**
- `src/components/events/EmailPreviewModal.tsx` â€” Add analysis bar
- May need to fetch `email_analyses` or use denormalized fields

### 1.4 â€” Sidebar: Actionable Badges

**Problem:** Sidebar shows category counts but nothing about what *needs attention*. A user scanning the sidebar has no idea that 3 emails need replies or that 2 deadlines are today.

**Fix:** Add two micro-badges to the sidebar:
- **Must-reply count** â€” red badge next to Inbox nav item (count of `reply_worthiness = 'must_reply'` + unread)
- **Today's deadlines count** â€” amber badge next to Calendar nav item

**Files:**
- `src/components/layout/Sidebar.tsx` â€” Add badge rendering
- `src/hooks/useEmails.ts` or new lightweight hook â€” Fetch counts

### 1.5 â€” Home DailyReviewCard: Add Quick Action + Category

**Problem:** DailyReviewCard shows signal strength and reply worthiness but is missing the quick_action badge and category â€” two pieces of context that help users decide what to do without clicking in.

**Fix:** Add quick action badge and category pill to each review row item.

**Files:**
- `src/components/home/DailyReviewCard.tsx` â€” Add badges to ReviewQueueItem

### 1.6 â€” Contact Detail Page: Email Intelligence Summary

**Problem:** The `/contacts/[id]` detail page likely shows contact info + email history but no aggregated intelligence from the analyzers (relationship trend over time, extracted dates, idea sparks from their emails, common topics).

**Fix:** Add an "Intelligence" section to the contact detail page:
- **Relationship signal trend** â€” positive/neutral/negative from recent emails
- **Common topics** â€” aggregated from emails with this contact
- **Extracted dates** â€” birthdays, deadlines, events from their emails
- **Communication stats** â€” emails/month sparkline, avg response time

**Files:**
- `src/app/(auth)/contacts/[id]/page.tsx` â€” Add intelligence section
- New hook or API route to aggregate per-contact analyzer data

### 1.7 â€” Calendar: Event Locality + Key Date Badges

**Problem:** The multi-event detector extracts `event_locality` (local / out_of_town / virtual) and `key_date_type` (registration_deadline, open_house, etc.) but the calendar view doesn't surface these.

**Fix:** Add locality badge and key date type badge to calendar list items. Color-code: green for local, blue for virtual, orange for out-of-town.

**Files:**
- `src/components/calendar/` â€” Update event list item rendering
- Check if `event_metadata` JSONB is being passed through to the calendar components

### 1.8 â€” Golden Nuggets: Count Indicator in List Views

**Problem:** ContentDigest extracts up to 7 golden nuggets per email (deals, tips, quotes, stats, recommendations). These are fully rendered in EmailDetail but there's zero indicator in list views â€” users don't know which emails have nuggets without opening each one.

**Fix:** Two options (choose based on performance):

**Option A (Preferred â€” Denormalize):** Add `golden_nugget_count INTEGER DEFAULT 0` to emails table. Set during analysis. Show a gem icon + count in InboxEmailRow/Card when > 0.

**Option B (Lightweight):** Use the `labels` array. During analysis, push a `has_nuggets` label if nuggets are found. Check labels in list view components.

**Files:**
- Migration for new column or label push in email processor
- `src/components/inbox/InboxEmailRow.tsx` â€” Add gem badge
- `src/components/inbox/InboxEmailCard.tsx` â€” Add gem badge
- `src/components/categories/EmailCard.tsx` â€” Add gem badge

---

## Phase 2: Smart Display Patterns + New Surfaces

**Theme:** Introduce new UI paradigms that make the intelligence *feel* smart. Hover previews, filter shortcuts, dedicated browse pages, and aggregated views.

### 2.1 â€” Email Hover Card (Quick Intelligence Preview)

**Problem:** To see any analysis detail, users must click into the email detail â€” a full modal load. For rapid triage, users want to preview the key intelligence without committing to a full open.

**Design:** On hover (desktop) or long-press (mobile), show a floating card with:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“Š High Signal  Â·  Must Reply  Â·  Work  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  "Key client asking about Q2 deliverable"â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  ğŸ’ 2 nuggets  Â·  ğŸ“… Deadline: Mar 3     â”‚
â”‚  ğŸ’¡ 1 idea spark  Â·  ğŸ”— 3 links          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  âš¡ Reply  Â·  ğŸ“Œ Save  Â·  ğŸ“‚ Archive     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Implementation:**
- New `EmailHoverCard` component using Popover/HoverCard from shadcn
- Triggered on InboxEmailRow, InboxEmailCard, PriorityEmailList rows
- Data: uses `email_analyses` JSONB (lazy-loaded on hover with debounce)
- Quick action buttons that work without opening the email

**Files:**
- New: `src/components/email/EmailHoverCard.tsx`
- Modified: InboxEmailRow, InboxEmailCard, PriorityEmailList â€” add hover trigger

### 2.2 â€” Smart Inbox Filters Bar

**Problem:** Users can't quickly filter the inbox by analyzer intelligence. "Show me only emails I need to reply to" or "Show me high-signal emails only" requires mentally scanning every row.

**Design:** A compact filter bar above the inbox list:
```
[All] [Must Reply (3)] [High Signal (7)] [Has Actions (5)] [Has Nuggets (2)] [Events (4)]
```

Each filter is a toggle chip. Multiple can be active. Counts update live.

**Implementation:**
- New `InboxFilterBar` component
- Leverages existing `useEmails` hook filters (add `reply_worthiness`, `signal_strength`, `labels` filter support)
- Persist active filters in URL params for shareability

**Files:**
- New: `src/components/inbox/InboxFilterBar.tsx`
- Modified: `src/hooks/useEmails.ts` â€” Add filter parameters
- Modified: `src/components/inbox/InboxFeed.tsx` â€” Integrate filter bar

### 2.3 â€” Email Style Ideas Feed (Home Card)

**Problem:** Email style ideas (layout, subject line, tone, CTA, storytelling, visual, personalization) are extracted by ContentDigest but only visible in EmailDetail. For a solopreneur who sends marketing emails, this is hidden gold.

**Design:** New Home page card â€” "Style Inspiration" â€” showing recent email style ideas with source email reference and "why it works" explanation. Same pattern as IdeaSparksCard.

**Implementation:**
- The data already comes through `email_analyses.content_digest.emailStyleIdeas`
- Need a new hook `useEmailStyleIdeas` to aggregate across recent emails
- New API route `/api/style-ideas` to query
- New component `StyleInspirationCard`

**Files:**
- New: `src/hooks/useEmailStyleIdeas.ts`
- New: `src/app/api/style-ideas/route.ts`
- New: `src/components/home/StyleInspirationCard.tsx`
- Modified: `src/app/(auth)/home/page.tsx` â€” Add card to dashboard

### 2.4 â€” Dedicated Browse Pages (Insights, News, Links)

**Problem:** Ideas, insights, news, and links each have Home page cards showing ~5 items. But there's no way to browse the full history, search, or manage saved items. Users can't filter insights by topic or find a link they saw last week.

**Design:** Add full-page browse views as Inbox sub-tabs:
- `/inbox?tab=ideas` â€” Full ideas feed (already exists as IdeasFeed)
- `/inbox?tab=insights` â€” Full insights feed (already exists as InsightsFeed)
- `/inbox?tab=news` â€” Full news feed (already exists as NewsFeed)
- `/inbox?tab=links` â€” Full links feed with save/dismiss/open tracking

Each page gets:
- Search bar (by keyword, topic)
- Filter chips (by type: tip/framework/trend, by confidence level, by saved status)
- Sort options (newest, highest confidence, by topic)
- Pagination

**Implementation:**
- These feeds mostly exist in `/src/components/inbox/` already
- Need to add search/filter/sort controls
- Need full-page layout wrappers

**Files:**
- Modified: `src/components/inbox/InsightsFeed.tsx` â€” Add search, filter, sort
- Modified: `src/components/inbox/NewsFeed.tsx` â€” Add search, filter, sort
- Modified: `src/components/inbox/IdeasFeed.tsx` â€” Add search, filter, sort
- New: `src/components/inbox/LinksFeed.tsx` â€” Full links browse page
- Modified: Inbox tabs configuration to include these views

### 2.5 â€” Thread Intelligence Aggregation

**Problem:** When multiple emails in a thread are analyzed, each is treated independently. A thread with 5 replies might have 3 action items, 2 events, and evolving relationship signals â€” but users see these scattered across individual emails.

**Design:** Thread summary badge on inbox rows showing aggregated intelligence:
- "3 actions in this thread"
- "Deadline shifted from Mar 3 â†’ Mar 10"
- "Relationship signal: positive â†’ negative over 5 exchanges"

**Implementation:**
- Group emails by `thread_id` in queries
- Aggregate analyzer outputs per thread
- New `ThreadIntelligenceBadge` component

**Files:**
- New: `src/hooks/useThreadIntelligence.ts`
- New: `src/components/email/ThreadIntelligenceBadge.tsx`
- Modified: InboxEmailRow/Card â€” Show thread badge for multi-email threads

### 2.6 â€” Confidence-Based Visual Affordances

**Problem:** AI analysis confidence scores are available but hidden. Users trust all analysis equally â€” they can't tell when the AI is guessing vs. certain.

**Design:**
- Low-confidence gist text (< 0.5) gets slightly faded + italic styling + a subtle "?" indicator
- Low-confidence categorization shows a "Suggested" prefix instead of assertive category badge
- High-confidence (> 0.9) elements get a subtle checkmark or "Verified" micro-badge

**Implementation:**
- Utility function `getConfidenceStyle(score)` returning className + prefix
- Apply to gist, category badges, action suggestions across all components

**Files:**
- New: `src/lib/utils/confidence.ts` â€” Shared confidence styling utility
- Modified: All list view components â€” Apply confidence-aware styling

### 2.7 â€” Action Quick-Complete from List View

**Problem:** When an email has an action item (respond, schedule, pay), the user must: open email â†’ see action â†’ open action â†’ complete it. That's 3 clicks for something that could be 1.

**Design:** Quick action buttons directly on inbox rows for high-priority actions:
- "Reply" button that opens compose
- "Schedule" button that opens calendar add
- "Done" button that marks the action complete
- Only shown for emails with `urgency_score >= 7` or `reply_worthiness = 'must_reply'`

**Implementation:**
- Inline action buttons on InboxEmailRow (shown on hover)
- Connects to existing email action handlers (reply, archive, etc.)
- Marks underlying `action` as completed when "Done" is clicked

**Files:**
- New: `src/components/email/QuickActionButtons.tsx`
- Modified: InboxEmailRow, InboxEmailCard â€” Add inline action buttons
- Modified: `src/hooks/useActions.ts` â€” Add `completeByEmailId` method

---

## Implementation Order

### Phase 1 (Fix & Surface â€” ~5-7 work sessions)
```
1.1  Denormalize urgency_score + relationship_signal  (migration + processor + types)
1.8  Golden nuggets indicator in list views            (migration or label + 3 components)
1.2  CategoryModal upgrade                             (1 component)
1.3  EmailPreviewModal analysis bar                    (1 component)
1.5  DailyReviewCard quick_action + category           (1 component)
1.4  Sidebar actionable badges                         (1 component + hook)
1.7  Calendar locality + key date badges               (calendar components)
1.6  Contact detail intelligence section               (1 page + hook/API)
```

### Phase 2 (Smart Display â€” ~6-8 work sessions)
```
2.2  Smart inbox filter bar                            (1 component + hook changes)
2.1  Email hover card                                  (1 component + integration)
2.3  Email style ideas feed                            (hook + API + component)
2.6  Confidence-based visual affordances               (utility + all components)
2.4  Full browse pages for insights/news/links         (enhance existing feeds)
2.7  Action quick-complete from list view              (component + hook)
2.5  Thread intelligence aggregation                   (hook + component â€” most complex)
```

---

## Files Changed Summary

### Phase 1 New Files (7)
- `supabase/migrations/043_denormalize_urgency_relationship.sql`
- `supabase/migrations/044_golden_nugget_count.sql` (if Option A)
- `src/components/email/AnalysisSummaryBar.tsx` (for EmailPreviewModal)
- `src/hooks/useContactIntelligence.ts`
- `src/app/api/contacts/[id]/intelligence/route.ts`

### Phase 1 Modified Files (12+)
- `src/services/processors/email-processor.ts`
- `src/types/database.ts`
- `src/hooks/useEmails.ts`
- `src/components/discover/CategoryModal.tsx`
- `src/components/events/EmailPreviewModal.tsx`
- `src/components/layout/Sidebar.tsx`
- `src/components/home/DailyReviewCard.tsx`
- `src/components/calendar/*` (event list items)
- `src/app/(auth)/contacts/[id]/page.tsx`
- `src/components/inbox/InboxEmailRow.tsx`
- `src/components/inbox/InboxEmailCard.tsx`
- `src/components/categories/EmailCard.tsx`

### Phase 2 New Files (8)
- `src/components/email/EmailHoverCard.tsx`
- `src/components/email/QuickActionButtons.tsx`
- `src/components/inbox/InboxFilterBar.tsx`
- `src/components/inbox/LinksFeed.tsx`
- `src/components/home/StyleInspirationCard.tsx`
- `src/hooks/useEmailStyleIdeas.ts`
- `src/hooks/useThreadIntelligence.ts`
- `src/lib/utils/confidence.ts`

### Phase 2 Modified Files (10+)
- `src/app/api/style-ideas/route.ts`
- `src/hooks/useEmails.ts`
- `src/hooks/useActions.ts`
- `src/components/inbox/InboxFeed.tsx`
- `src/components/inbox/InsightsFeed.tsx`
- `src/components/inbox/NewsFeed.tsx`
- `src/components/inbox/IdeasFeed.tsx`
- `src/components/inbox/InboxEmailRow.tsx`
- `src/components/inbox/InboxEmailCard.tsx`
- `src/app/(auth)/home/page.tsx`
